<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Tomato Jam</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#fff7f7; margin:0; padding:0; }
    .checkout-container { max-width:900px; margin:1rem auto; background:#fff; border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,0.08); overflow:hidden; }
    header { background:#d62828; padding:1rem; color:#fff; text-align:center; }
    header h1 { margin:0; font-size:1.4rem; }

    .content { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; padding:1.5rem; }
    .order-summary { background:#fff0f0; border:1px solid #f5c2c2; border-radius:12px; padding:1rem; }
    .order-summary h2 { margin:0 0 0.8rem; color:#d62828; font-size:1.2rem; }
    .summary-row, .final-total { display:flex; justify-content:space-between; margin:0.4rem 0; font-size:0.95rem; }
    .final-total { border-top:1px solid #e6bcbc; margin-top:0.8rem; padding-top:0.8rem; font-weight:700; color:#d62828; }

    form label { font-weight:600; margin-bottom:0.2rem; display:block; color:#444; }
    form input, form select { width:100%; border:1px solid #ccc; border-radius:8px; padding:0.7rem; margin-bottom:0.8rem; font-size:0.95rem; }

    .btn { width:100%; padding:0.9rem; font-size:1rem; border-radius:10px; cursor:pointer; border:none; transition:0.3s; }
    .btn-primary { background:#d62828; color:white; }
    .btn-primary:hover { background:#a81f1f; }

    .hidden { display:none; }
    .payment-options { padding:1.5rem; text-align:center; }
    .payment-method { border:1px solid #ddd; border-radius:10px; padding:0.8rem; margin:0.8rem 0; cursor:pointer; transition:.3s; }
    .payment-method:hover { background:#fbeaea; }

    .bank-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:0.8rem; margin-top:1rem; }
    .bank-item { border:1px solid #ddd; border-radius:8px; padding:0.5rem; text-align:center; cursor:pointer; background:#fff;
      display:flex; align-items:center; justify-content:center; gap:0.4rem; }
    .bank-item img { width:28px; height:28px; object-fit:contain; }
    .bank-details { margin-top:1rem; padding:0.8rem; border:1px solid #ccc; border-radius:10px; background:#fff7f7; }

    .thank-card { max-width:420px; margin:1.5rem auto; background:#fff5f5; border:1px solid #f5c2c2; border-radius:12px; padding:1rem; text-align:left; }
    .thank-card h2 { color:#d62828; }

    /* Spinner */
    .spinner { border:4px solid #f3f3f3; border-top:4px solid #e63946; border-radius:50%; width:36px; height:36px;
      animation: spin 1s linear infinite; margin:1rem auto; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .loading-box { text-align:center; padding:1.5rem; }

    /* Mobile Responsiveness */
    @media(max-width:768px){
      .content { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="checkout-container">
    <header><h1 id="checkout-header">üçÖ Checkout - Tomato Jam</h1></header>

    <!-- Step 1: Checkout -->
    <section id="checkout-step" class="content">
      <div class="order-summary">
        <h2>üçÖ Please Note:</h2>
        <ul>
          <li>Review your order and complete your details below.</li>
          <li>You‚Äôll receive confirmation after placing order.</li>
          <li>Ensure someone is available to receive your order.</li>
          <li>We allow 2 re-delivery attempts. Failed orders will be cancelled with no refund.</li>
        </ul>
        <h2>Order Summary</h2>
        <div class="summary-row"><span>Product:</span><span>Tomato Jam (120ml)</span></div>
        <div class="summary-row"><span>Price:</span><span id="product-price">‚Ç±90.00</span></div>
        <div class="summary-row"><span>Quantity:</span><span id="quantity-display">1</span></div>
        <div class="summary-row"><span>Shipping Fee:</span><span id="shipping-display">‚Ç±50.00</span></div>
        <div class="final-total"><span>Total:</span><span id="total-display">‚Ç±140.00</span></div>
      </div>

      <form id="checkout-form">
        <label>Name</label>
        <input id="name" required>
        <label>Contact Number</label>
        <input id="contactNumber" required placeholder="+63 900 000 0000">
        <label>Email</label>
        <input id="email" type="email" required placeholder="tomatojam@example.com">
        <label>City (Metro Manila only)</label>
        <select id="city" required>
          <option value="">-- Select City --</option>
          <option>Caloocan</option><option>Las Pi√±as</option><option>Makati</option>
          <option>Malabon</option><option>Mandaluyong</option><option>Manila</option>
          <option>Marikina</option><option>Muntinlupa</option><option>Navotas</option>
          <option>Para√±aque</option><option>Pasay</option><option>Pasig</option>
          <option>Pateros</option><option>Quezon City</option><option>San Juan</option>
          <option>Taguig</option><option>Valenzuela</option>
        </select>
        <label>Full Address</label>
        <input id="address" required>
        <button type="submit" class="btn btn-primary">Confirm Order</button>
      </form>
    </section>

    <!-- Step 2: Payment -->
    <section id="payment-step" class="payment-options hidden">
      <h2>Select Payment Method</h2>
      <div class="payment-method" data-method="gcash">üí≥ Pay with GCash</div>
      <div class="payment-method" data-method="bank">üè¶ Bank Transfer</div>
      <div class="payment-method" data-method="cod">üì¶ Cash on Delivery</div>

      <!-- GCash -->
      <div id="gcash-box" class="hidden">
        <h3>Scan QR with GCash</h3>
        <img src="src/assets/QR-code.jpeg" alt="GCash QR" width="200">
        <p>Upload payment receipt: <input type="file" id="gcash-file" accept="image/*"></p>
        <button class="btn btn-primary" id="gcash-done">Done</button>
      </div>

      <!-- Banks -->
      <div id="bank-box" class="hidden">
        <h3>Select Your Bank</h3>
        <div class="bank-list" id="bank-list"></div>
        <div id="bank-details" class="bank-details hidden"></div>
        <p style="margin-top:1rem;">Upload proof: <input type="file" id="bank-file" accept="image/*"></p>
        <button class="btn btn-primary" id="bank-done">Done</button>
      </div>
    </section>

    <!-- Loading -->
    <div id="loading-step" class="hidden loading-box">
      <div class="spinner"></div>
      <p>Processing your order...</p>
    </div>

    <!-- Thank You -->
    <section id="thank-step" class="thank-card hidden">
      <h2>Thank you for purchasing! üçÖ</h2>
      <p>We‚Äôll reach out soon using your details.</p>
      <div id="order-details"></div>
      <button class="btn btn-primary" id="home-btn">Navigate to Home</button>
    </section>
  </div>

<script>
(() => {
  const basePrice = 90, qty = 1;
  let shippingFee = 50, selectedBank = "", orderInfo = {};

  // DOM Elements
  const form = document.getElementById("checkout-form"),
        citySelect = document.getElementById("city"),
        shippingDisplay = document.getElementById("shipping-display"),
        totalDisplay = document.getElementById("total-display"),
        checkoutStep = document.getElementById("checkout-step"),
        paymentStep = document.getElementById("payment-step"),
        thankStep = document.getElementById("thank-step"),
        orderDetails = document.getElementById("order-details"),
        loadingStep = document.getElementById("loading-step");

  const bankList = document.getElementById("bank-list"),
        bankDetails = document.getElementById("bank-details");

  const shippingRates = {
    "Caloocan":120,"Las Pi√±as":170,"Makati":120,"Malabon":120,
    "Mandaluyong":150,"Manila":150,"Marikina":150,"Muntinlupa":180,
    "Navotas":120,"Para√±aque":170,"Pasay":160,"Pasig":150,
    "Pateros":110,"Quezon City":120,"San Juan":150,"Taguig":160,"Valenzuela":80
  };

  const bankAccounts = {
    "BDO":"1234-5678-90","BPI":"9876-5432-10","Metrobank":"1122-3344-55",
    "LandBank":"6677-8899-00","UnionBank":"4455-6677-88",
    "Security Bank":"9988-7766-55","China Bank":"2233-4455-66","RCBC":"7788-9900-11"
  };

  // Populate banks dynamically
  bankList.innerHTML = Object.keys(bankAccounts)
    .map(b => `<div class="bank-item" data-bank="${b}"><img src="src/assets/${b.toLowerCase().replace(' ','')}.png" alt="${b}"> ${b}</div>`).join("");

  // Calculate total
  const updateTotal = () => {
    const total = basePrice * qty + shippingFee;
    totalDisplay.textContent = `‚Ç±${total.toFixed(2)}`;
    return total;
  };

  // File -> Base64
  const fileToBase64 = file => new Promise((res,rej)=>{
    if(!file) return res(null);
    const reader=new FileReader();
    reader.onload=()=>res(reader.result);
    reader.onerror=rej;
    reader.readAsDataURL(file);
  });

  // Submit form
  form.addEventListener("submit", e => {
    e.preventDefault();
    const total = updateTotal();
    orderInfo = {
      name:form.name.value, contact:form.contactNumber.value, email:form.email.value,
      city:citySelect.value, address:form.address.value,
      product:"Tomato Jam (120ml)", price:basePrice, qty, shipping:shippingFee, total
    };
    checkoutStep.classList.add("hidden");
    loadingStep.classList.remove("hidden");
    setTimeout(()=>{ loadingStep.classList.add("hidden"); paymentStep.classList.remove("hidden"); }, 1200);
  });

  // Shipping on city change
  citySelect.addEventListener("change", e=>{
    shippingFee = shippingRates[e.target.value] || 50;
    shippingDisplay.textContent = `‚Ç±${shippingFee.toFixed(2)}`;
    updateTotal();
  });

  // Payment selection
  document.querySelectorAll(".payment-method").forEach(el=>{
    el.addEventListener("click", ()=>{
      document.getElementById("gcash-box").classList.add("hidden");
      document.getElementById("bank-box").classList.add("hidden");
      if(el.dataset.method==="gcash") document.getElementById("gcash-box").classList.remove("hidden");
      if(el.dataset.method==="bank") document.getElementById("bank-box").classList.remove("hidden");
      if(el.dataset.method==="cod") alert("COD is not available at the moment.");
    });
  });

  // Bank select
  bankList.addEventListener("click", e=>{
    const target=e.target.closest(".bank-item");
    if(!target) return;
    selectedBank=target.dataset.bank;
    bankDetails.classList.remove("hidden");
    bankDetails.innerHTML=`<h4>${selectedBank} Account</h4>
      <p><strong>Name:</strong> Tomato Jam PH</p>
      <p><strong>No:</strong> ${bankAccounts[selectedBank]}</p>`;
  });

  // Done buttons
  document.getElementById("gcash-done").addEventListener("click", async()=>{
    const proof=await fileToBase64(document.getElementById("gcash-file").files[0]);
    if(!proof) return alert("Upload GCash receipt.");
    finalizeOrder("GCash",proof);
  });

  document.getElementById("bank-done").addEventListener("click", async()=>{
    if(!selectedBank) return alert("Select a bank first.");
    const proof=await fileToBase64(document.getElementById("bank-file").files[0]);
    if(!proof) return alert("Upload bank payment proof.");
    finalizeOrder(`Bank (${selectedBank})`,proof);
  });

  async function finalizeOrder(method,proof){
    orderInfo.paymentMethod = method;
    orderInfo.paymentProof = proof; // base64 string

  try {
    const url = "https://script.google.com/macros/s/AKfycbzTVISaP3c7lPHq_SkznZFQ4sWXYzN2y4iDmJaXor0UYA0hbqQlS5G4EHoH_fvbqGlu/exec";

    const response = await fetch(url, {
      method: "POST",
      body: JSON.stringify(orderInfo), // ‚úÖ send as plain text
      headers: { "Content-Type": "text/plain" }
    });

    console.log("Sheet response:", await response.text());

    // Success UI
    paymentStep.classList.add("hidden");
    thankStep.classList.remove("hidden");
    document.getElementById("checkout-header").textContent = "‚úÖ Checkout Successfully";

    orderDetails.innerHTML = `
      <h3>Order Summary</h3>
      <p><strong>Product:</strong> ${orderInfo.product}</p>
      <p><strong>Total:</strong> ‚Ç±${orderInfo.total.toFixed(2)}</p>
      <h3>Customer</h3>
      <p>${orderInfo.name} - ${orderInfo.contact}</p>
      <p><strong>Payment Method:</strong> ${method}</p>
    `;

    document.getElementById("home-btn").onclick = () => {
      window.location.href = "index.html";
    };
  } catch (err) {
    console.error("Error sending order:", err);
    alert("An error occurred while placing your order. Please try again.");
    paymentStep.classList.remove("hidden");
    thankStep.classList.add("hidden");
  }
  }
})();
</script>
</body>
</html>
